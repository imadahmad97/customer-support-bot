<!doctype html>
<html>
<head>
  <title>Create a new bot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='questions.css') }}"
    />
    <script src="{{url_for('static', filename='questions.js')}}"></script>
<body>
  
  <div id="createChatbot">
    <form id="chatbotCreationForm" method="post" enctype="multipart/form-data">
        <!-- Chatbot Name -->
        <div class="form-group">
          <label for="chatbotName">Chatbot Name:</label>
          <input type="text" class="form-control" id="chatbotName" name="chatbotName" value="ChatBot">
        </div>
      
        <!-- Color Pickers -->
        <div class="form-group">
          <label for="cardBgColor">Card Background Color:</label>
          <input type="color" class="form-control" id="cardBgColor" name="cardBgColor">
        </div>
        <div class="form-group">
          <label for="msgContainerColor">Message Container Background Color:</label>
          <input type="color" class="form-control" id="msgContainerColor" name="msgContainerColor">
        </div>
        <div class="form-group">
          <label for="msgContainerSendColor">Message Container Send Background Color:</label>
          <input type="color" class="form-control" id="msgContainerSendColor" name="msgContainerSendColor">
        </div>
        <div class="form-group">
          <label for="userImgColor">User Image Background Color:</label>
          <input type="color" class="form-control" id="userImgColor" name="userImgColor">
        </div>
        
        <!-- Image Upload for Avatar -->
        <div class="form-group">
          <label for="avatar">Chatbot Avatar:</label>
          <input type="file" class="form-control-file" id="avatar" name="avatar" accept="image/*" onchange="previewAvatar(this);">
          <img id="avatarPreview" src="#" alt="Avatar Preview" style="max-width: 100px; max-height: 100px; display: none;">
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </form>
      <div class="preview-container">
        <iframe id="chatPreview" src="/chat_preview" style="width: 100%; height: 400px; border: none;"></iframe>
    </div>    
    </div>

    <div id="questionsModal" style="display:none;">
      <body>
        <!-- Modal for Initial Questions -->
        <div class="modal" tabindex="-1" role="dialog" id="initialQuestionsModal">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  Welcome! Let's Customize Your Experience
                </h5>
                <button
                  type="button"
                  class="close"
                  data-dismiss="modal"
                  aria-label="Close"
                >
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <!-- Question 1 -->
                <div class="question" id="question1">
                  <div class="form-group">
                    <label for="companyContext"
                      ><strong>Company and Product Context</strong> <br /><br />Can
                      you describe your company in a few sentences? <br /><br />What
                      products or services does your company offer? <br /><br />Who
                      are your main customers or target audience?
                    </label>
                    <textarea
                      class="form-control"
                      id="companyContext"
                      required
                    ></textarea>
                    <button type="button" class="btn btn-primary next-btn">
                      Next
                    </button>
                  </div>
                </div>
                <!-- Question 2 -->
                <div class="question" id="question2" style="display: none">
                  <div class="form-group">
                    <label for="botInfo"
                      ><strong>Chatbot Identity and Tone</strong> <br /><br />What
                      name would you like your chatbot to have? <br /><br />How
                      would you describe the tone of voice you want the chatbot to
                      use? For example, formal, friendly, technical, etc.
                      <br /><br />Are there any specific phrases or greetings you
                      would like the chatbot to use when starting conversations?
                    </label>
                    <textarea
                      class="form-control"
                      id="botInfo"
                      required
                    ></textarea>
                    <button type="button" class="btn btn-primary next-btn">
                      Next
                    </button>
                  </div>
                </div>
                <!-- Question 3 -->
                <div class="question" id="question3" style="display: none">
                  <div class="form-group">
                    <label for="botGoals"
                      ><strong>Purpose and Goals</strong> <br /><br />What are the
                      main tasks you want the chatbot to handle? For example,
                      answering FAQs, booking appointments, providing support, etc.
                      <br /><br />What are the key goals you want to achieve with
                      this chatbot? For example, reducing support ticket volume,
                      improving customer satisfaction, etc.
                    </label>
                    <textarea
                      class="form-control"
                      id="botGoals"
                      required
                    ></textarea>
                    <button type="button" class="btn btn-primary next-btn">
                      Next
                    </button>
                  </div>
                </div>
                <!-- Question 4 -->
                <div class="question" id="question4" style="display: none">
                  <div class="form-group">
                    <label for="ops">
                      <strong>Issue List</strong>
                      <br /><br />Please provide a list of common issues and how
                      they should be dealt with. For example, under the solution
                      column, you may put "Let customer know that username can be
                      changed in the user profile section in the app settings", or
                      "Escalate issue to support team". You can always add to this
                      list later.
                    </label>
                    <table class="table table-bordered" id="issuesTable">
                      <thead>
                        <tr>
                          <th>Problem</th>
                          <th>Solution</th>
                        </tr>
                      </thead>
                      <tbody contenteditable="true">
                        <tr>
                          <td><textarea
                            class="form-control"
                          ></textarea></td>
                          <td><textarea
                            class="form-control"
                          ></textarea></td>
                        </tr>
                      </tbody>
                    </table>
                    <button type="button" class="btn btn-primary" id="addRow">
                      Add an issue
                    </button>
                    <button type="button" class="btn btn-primary next-btn">
                      Next
                    </button>
                  </div>
                </div>
                <!-- Question 5 -->
                <div class="question" id="question5" style="display: none">
                  <div class="form-group">
                    <label for="botLang"
                      ><strong>Language and Localization</strong> <br /><br />What
                      languages do you need the chatbot to support? <br /><br />Are
                      there any regional or cultural considerations the chatbot
                      needs to be aware of when interacting with users?
                    </label>
                    <textarea
                      class="form-control"
                      id="botLang"
                      required
                    ></textarea>
                    <button type="button" class="btn btn-primary next-btn">
                      Next
                    </button>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="submitQuestions"
                  style="display: none"
                >
                  Submit
                </button>
              </div>
            </div>
          </div>
        </div>

    </div>
    <script src="{{url_for('static', filename='questions.js')}}"></script>
    <script>
$(document).ready(function() {
    // Handle the initial form submission via AJAX
    $('#chatbotCreationForm').submit(function(event) {
        event.preventDefault(); // Prevent the normal form submission
        var formData = new FormData(this);

        $.ajax({
            type: "POST",
            url: "/submit-initial-config", // Changed this to a different endpoint for initial config
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log("Initial configuration saved temporarily.");
                $('#createChatbot').hide();
                $('#questionsModal').show();
            },
            error: function() {
                console.error("Failed to save initial configuration.");
            }
        });
    });

    // Handle clicking on the 'Next' button which should show the questions modal
    $('#toQuestions').click(function() {
        $('#createChatbot').hide();
        $('#questionsModal').show();
    });

    // Handle closing the questions modal without submitting the full form
    $('#closeQuestions').click(function() {
        $('#questionsModal').hide();
        $('#createChatbot').show();
    });

    // Handle the submission of the full chatbot configuration including additional questions
    $('#submitQuestions').click(function() {
        var allData = {
            companyContext: $("#companyContext").val(),
            botInfo: $("#botInfo").val(),
            botGoals: $("#botGoals").val(),
            botLang: $("#botLang").val(),
            // You can add other fields here as necessary
        };

        $.ajax({
            type: "POST",
            url: "/create-new-bot", // This endpoint handles the creation of the bot with all details
            contentType: "application/json",
            data: JSON.stringify(allData),
            success: function(response) {
                console.log("Chatbot created successfully.");
                window.location.href = "/bots"; // Redirect to the list of bots or some confirmation page
            },
            error: function() {
                console.error("Failed to create chatbot.");
            }
        });
    });
    function updatePreview() {
        let iframe = document.getElementById('chatPreview').contentWindow.document;

        // Update styles dynamically
        iframe.querySelector('.card').style.backgroundColor = $('#cardBgColor').val();
        iframe.querySelector('.msg_container').style.backgroundColor = $('#msgContainerColor').val();
        iframe.querySelector('.msg_container_send').style.backgroundColor = $('#msgContainerSendColor').val();
        iframe.querySelector('.user_img').style.backgroundColor = $('#userImgColor').val();
        
        // Update avatar image if one has been chosen
        const avatarPreviewSrc = $('#avatarPreview').attr('src');
        if (avatarPreviewSrc) {
            iframe.querySelector('.user_img').src = avatarPreviewSrc;
        }
    }

    // Listen for changes in the input fields
    $('#cardBgColor, #msgContainerColor, #msgContainerSendColor, #userImgColor').change(updatePreview);

    // Assuming the avatar preview updates its `src` attribute on file input change
    $('#avatar').change(function() {
        let reader = new FileReader();
        reader.onload = function(e) {
            $('#avatarPreview').attr('src', e.target.result);
            updatePreview(); 
        };
        reader.readAsDataURL(this.files[0]);
    });
});


    </script>
</body>      